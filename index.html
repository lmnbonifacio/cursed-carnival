<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Cursed Carnival</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-void: #050505;
            --gold-base: #c5a059;
            --gold-highlight: #f0e68c;
            --gold-shadow: #8a6d3b;
            --blood: #8b0000;
            --blood-bright: #ff3333;
            --spirit: #aaddff;
            --poison-gas: #39ff14;
            --glass-panel: rgba(10, 5, 5, 0.90);
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Playfair Display', serif;
            background: url('assets/bg.png') no-repeat center center fixed;
            background-size: cover;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            user-select: none;
            overflow-y: auto;
        }

        body::after {
            content: "";
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, transparent 30%, #000 100%);
            pointer-events: none;
            z-index: 0;
        }

        .screen {
            position: relative;
            z-index: 10;
            background: var(--glass-panel);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(197, 160, 89, 0.3);
            box-shadow: 0 20px 50px rgba(0,0,0,0.9);
            padding: 40px; 
            border-radius: 8px;
            width: 95%; 
            max-width: 1100px;
            text-align: center; 
            margin: 20px 0;
            animation: fadeIn 0.6s forwards ease-out;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .hidden { display: none !important; }

        h1, h2 { 
            font-family: 'Cinzel', serif; 
            text-transform: uppercase; 
            letter-spacing: 0.15em; 
            margin-bottom: 15px;
            background: linear-gradient(to bottom, var(--gold-highlight), var(--gold-base));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        h1 { font-size: 3rem; margin-top: 0; }
        h2 { font-size: 2rem; border-bottom: 1px solid rgba(197, 160, 89, 0.2); padding-bottom: 15px; display: inline-block;}
        p { font-size: 1.1rem; color: #aaa; margin-bottom: 40px; font-style: italic; letter-spacing: 0.05em; }

        button {
            background: rgba(0,0,0,0.6);
            color: var(--gold-base);
            border: 1px solid var(--gold-shadow);
            padding: 15px 35px; 
            margin: 10px;
            font-family: 'Cinzel', serif; 
            font-size: 0.9rem; 
            font-weight: 700;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        button:hover { border-color: var(--gold-highlight); color: var(--gold-highlight); transform: translateY(-2px); box-shadow: 0 0 15px rgba(197, 160, 89, 0.3); }
        button:active { transform: scale(0.95); }

        .back-btn { 
            margin-top: 40px; 
            width: 100%; max-width: 300px;
            border: 1px solid #444; 
            color: #888; 
            background: rgba(0,0,0,0.4); 
        }
        .back-btn:hover { color: #fff; border-color: #fff; background: rgba(255,255,255,0.1); }

        /* --- GAME 1: WHEEL --- */
        .wheel-stage { position: relative; width: 500px; height: 500px; margin: 0 auto 30px auto; }
        #wheel-img { width: 100%; height: 100%; transition: transform 5s cubic-bezier(0.2, 0.8, 0.2, 1); filter: drop-shadow(0 0 30px rgba(0,0,0,0.9)); }
        #pointer-img { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); width: 80px; z-index: 10; filter: drop-shadow(0 5px 10px black); }
        .wheel-controls { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
        .wheel-btn { width: 50px; height: 50px; padding: 0; border-radius: 50%; line-height: 50px; }
        #wheel-result { min-height: 60px; margin-top: 20px; font-family: 'Cinzel'; font-size: 1.8rem; color: #fff; text-shadow: 0 0 10px var(--gold-base); opacity: 0; transition: opacity 0.5s; }

        /* --- GAME 2: DREDGES (VISIBILITY FIX) --- */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(3, 180px);
            gap: 20px;
            justify-content: center;
            margin: 20px auto;
        }

        .dredge-cell {
            width: 180px; height: 180px;
            position: relative; 
            cursor: crosshair;
            overflow: hidden; /* This crops the square image to a circle */
            border-radius: 50%; 
        }

        .portal-img {
            width: 100%; height: 100%;
            position: absolute; top: 0; left: 0; 
            z-index: 5; /* Middle Layer */
            pointer-events: none;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.8));
        }

        /* FIX: Z-Index 6 puts it ON TOP of the portal so it is definitely seen */
        .dretch-img {
            width: 70%; 
            height: 70%;
            position: absolute; 
            top: 15%; left: 15%; 
            z-index: 6; /* Top Layer */
            border-radius: 50%; 
            object-fit: cover; 
            transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: scale(0);
            filter: drop-shadow(0 0 10px rgba(0,0,0,0.8));
        }
        .dretch-active { transform: scale(1); }

        .poison-overlay {
            position: absolute; top: -10%; left: -10%; width: 120%; height: 120%;
            background: radial-gradient(circle, var(--poison-gas) 20%, transparent 70%);
            opacity: 0; z-index: 10; pointer-events: none;
            mix-blend-mode: hard-light; 
            filter: blur(8px);
        }
        .poison-active { animation: gasExplode 1s ease-out forwards; }
        @keyframes gasExplode { 
            0% {opacity: 0; transform: scale(0.5); } 
            20% { opacity: 0.9; transform: scale(1.1); } 
            100% {opacity: 0; transform: scale(1.4); } 
        }

        /* --- GAME 3: BRIDGE (THINNER) --- */
        .bridge-container {
            position: relative; width: 100%; max-width: 900px; height: 450px;
            margin: 0 auto; background: radial-gradient(circle at center, #111 0%, #000 100%);
            border: 1px solid #333; box-shadow: inset 0 0 50px #000;
            cursor: none; overflow: hidden; border-radius: 4px;
        }

        /* FIX: Reduced stroke-width to 20px */
        #bridge-path {
            fill: none;
            stroke: var(--spirit);
            stroke-width: 20px; 
            stroke-linecap: square; 
            stroke-linejoin: bevel; 
            filter: blur(4px);
            opacity: 0.2;
            animation: pulsePath 3s infinite alternate;
        }
        @keyframes pulsePath { 
            from { opacity: 0.15; stroke-width: 20px; } 
            to { opacity: 0.3; stroke-width: 25px; } 
        }

        #bridge-core { fill: none; stroke: rgba(255,255,255,0.8); stroke-width: 1px; stroke-dasharray: 5, 15; opacity: 0.5; }
        #spirit-cursor { width: 12px; height: 12px; background: #fff; border-radius: 50%; position: absolute; pointer-events: none; box-shadow: 0 0 10px #fff, 0 0 20px var(--spirit); transform: translate(-50%, -50%); z-index: 20; display: none; mix-blend-mode: screen; }
        .fail-state { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; box-shadow: inset 0 0 100px var(--blood) !important; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        #fail-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-family: 'Cinzel'; font-size: 5rem; color: var(--blood-bright); text-shadow: 0 0 20px var(--blood); display: none; pointer-events: none; z-index: 30; }

        /* --- GAME 5: ROPERS --- */
        .vial-rack { display: flex; justify-content: center; gap: 30px; margin: 40px 0; perspective: 1000px; flex-wrap: wrap;}
        .vial-unit { display: flex; flex-direction: column; align-items: center; width: 120px; transition: transform 0.3s; }
        .vial-unit:hover { transform: translateZ(20px); }
        .vial-display { width: 120px; height: 240px; position: relative; }
        .vial-bg { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; filter: drop-shadow(0 10px 10px #000); opacity: 0.8; }
        .vial-mask { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; overflow: hidden; z-index: 2; transition: height 0.6s cubic-bezier(0.22, 1, 0.36, 1); filter: drop-shadow(0 0 15px var(--blood)); }
        .vial-fg { width: 120px; height: 240px; position: absolute; bottom: 0; left: 0; }
        .vial-unit input { background: rgba(0,0,0,0.5); border: none; border-bottom: 2px solid var(--gold-shadow); color: var(--gold-highlight); font-family: 'Cinzel'; font-size: 1.5rem; text-align: center; width: 80px; margin-top: 15px; padding: 5px; transition: 0.3s; }
        .vial-unit input:focus { outline: none; border-color: var(--gold-highlight); background: rgba(0,0,0,0.8); }
        .attacking-text { color: var(--blood-bright); font-weight: bold; text-shadow: 0 0 10px var(--blood); }

    </style>
</head>
<body>

    <div id="hub" class="screen">
        <h1>The Cursed Carnival</h1>
        <p>Select the encounter to begin the torment.</p>
        <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
            <button onclick="nav('game1')">I. Wheel of Fortune</button>
            <button onclick="nav('game2')">II. Nine Dredges</button>
            <button onclick="nav('game3')">III. The Spectral Bridge</button>
            <button onclick="nav('game5')">V. The Ropers</button>
        </div>
    </div>

    <div id="game1" class="screen hidden">
        <h2>Wheel of Fortune</h2>
        <p>Cast the physical die (1d8). Consult fate below.</p>
        
        <div class="wheel-stage">
            <img src="assets/pointer.png" id="pointer-img" alt="Pointer">
            <img src="assets/wheel.png" id="wheel-img" alt="Wheel">
        </div>

        <div class="wheel-controls">
            <button class="wheel-btn" onclick="spinWheel(1)">1</button>
            <button class="wheel-btn" onclick="spinWheel(2)">2</button>
            <button class="wheel-btn" onclick="spinWheel(3)">3</button>
            <button class="wheel-btn" onclick="spinWheel(4)">4</button>
            <button class="wheel-btn" onclick="spinWheel(5)">5</button>
            <button class="wheel-btn" onclick="spinWheel(6)">6</button>
            <button class="wheel-btn" onclick="spinWheel(7)">7</button>
            <button class="wheel-btn" onclick="spinWheel(8)">8</button>
        </div>

        <div id="wheel-result"></div>
        <button class="back-btn" onclick="nav('hub')">Return to Hub</button>
    </div>

    <div id="game2" class="screen hidden">
        <h2>Whack-a-Dredge</h2>
        <p>Attack Hit: Click Portal. <br>Attack Miss: Click "Missed Attack".</p>
        
        <div class="grid-container" id="dredge-grid"></div>

        <button onclick="triggerPoison()" style="border-color: #39ff14; color: #39ff14; margin-top: 20px;">Attack Missed (Trigger Gas)</button>
        <br>
        <button class="back-btn" onclick="nav('hub')">Return to Hub</button>
    </div>

    <div id="game3" class="screen hidden">
        <h2>The Spectral Bridge</h2>
        <p>Guide the soul. The path is treacherous and narrow.</p>
        
        <div class="bridge-container" id="bridge-ui">
            <div id="spirit-cursor"></div>
            <div id="fail-msg">FALLEN</div>
            
            <svg width="100%" height="100%" viewBox="0 0 900 450">
                <path id="bridge-path" 
                      d="M 50 400 L 150 300 L 200 400 L 350 100 L 500 350 L 650 50 L 850 225" 
                      onmouseenter="enterBridge()" 
                      onmouseleave="fallOffBridge()" />
                
                <path id="bridge-core" 
                      d="M 50 400 L 150 300 L 200 400 L 350 100 L 500 350 L 650 50 L 850 225" 
                      pointer-events="none" />
            </svg>
        </div>

        <button class="back-btn" onclick="nav('hub')">Return to Hub</button>
    </div>

    <div id="game5" class="screen hidden">
        <h2>Specimen Feeding</h2>
        <p>Input damage dealt. The hungriest specimen (Lowest HP) will retaliate.</p>
        
        <div class="vial-rack">
            <div class="vial-unit">
                <div class="vial-display">
                    <img src="assets/vial-empty.png" class="vial-bg">
                    <div class="vial-mask" id="mask-1"><img src="assets/vial-complete.png" class="vial-fg"></div>
                </div>
                <input type="number" id="dmg-1" value="0" oninput="updateVials()">
            </div>
            <div class="vial-unit">
                <div class="vial-display">
                    <img src="assets/vial-empty.png" class="vial-bg">
                    <div class="vial-mask" id="mask-2"><img src="assets/vial-complete.png" class="vial-fg"></div>
                </div>
                <input type="number" id="dmg-2" value="0" oninput="updateVials()">
            </div>
            <div class="vial-unit">
                <div class="vial-display">
                    <img src="assets/vial-empty.png" class="vial-bg">
                    <div class="vial-mask" id="mask-3"><img src="assets/vial-complete.png" class="vial-fg"></div>
                </div>
                <input type="number" id="dmg-3" value="0" oninput="updateVials()">
            </div>
            <div class="vial-unit">
                <div class="vial-display">
                    <img src="assets/vial-empty.png" class="vial-bg">
                    <div class="vial-mask" id="mask-4"><img src="assets/vial-complete.png" class="vial-fg"></div>
                </div>
                <input type="number" id="dmg-4" value="0" oninput="updateVials()">
            </div>
        </div>

        <button onclick="calculateAggro()">Identify Threat</button>
        <div id="roper-res" style="min-height: 2em; margin-top:20px; font-size: 1.4rem; font-family: 'Cinzel'"></div>
        
        <button class="back-btn" onclick="nav('hub')">Return to Hub</button>
    </div>

    <script>
        // --- NAVIGATION & INIT ---
        function nav(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            const active = document.getElementById(id);
            active.classList.remove('hidden');
            active.style.animation = 'none';
            active.offsetHeight; /* trigger reflow */
            active.style.animation = 'fadeIn 0.6s forwards ease-out';
            if(id === 'game2') initDredges();
            if(id === 'game3') initBridge();
        }

        // --- GAME 1: WHEEL ---
        const outcomes = ["Poison Darts", "Psychic Scream", "Fog Cloud", "Gravity Well", "Necrotic Rot", "Silence", "Mirror Image"];
        let currentDeg = 0;
        function spinWheel(val) {
            const wheel = document.getElementById('wheel-img');
            const resDiv = document.getElementById('wheel-result');
            const extraSpins = 1080 + (val * 45); 
            const randomOffset = Math.floor(Math.random() * 20);
            currentDeg += extraSpins + randomOffset;
            wheel.style.transform = `rotate(${currentDeg}deg)`;
            resDiv.style.opacity = '0'; 
            setTimeout(() => {
                resDiv.style.opacity = '1';
                if (val === 8) {
                    resDiv.innerHTML = "<span style='color:var(--gold-highlight); text-shadow:0 0 20px var(--gold-highlight)'>✨ THE GATE OPENS ✨</span>";
                } else {
                    const bad = outcomes[Math.floor(Math.random() * outcomes.length)];
                    resDiv.innerHTML = `Rolled ${val}: <span style='color:var(--blood-bright)'>${bad}</span>`;
                }
            }, 5000); 
        }

        // --- GAME 2: DREDGES ---
        let currentDredgeIdx = -1;
        function initDredges() {
            const grid = document.getElementById('dredge-grid');
            grid.innerHTML = '';
            for(let i=0; i<9; i++) {
                const cell = document.createElement('div');
                cell.className = 'dredge-cell';
                cell.id = `cell-${i}`;
                
                const poison = document.createElement('div');
                poison.className = 'poison-overlay';
                cell.appendChild(poison);

                const monster = document.createElement('img');
                monster.src = 'assets/dretch.png';
                monster.className = 'dretch-img';
                monster.onclick = (e) => whackDredge(e);
                cell.appendChild(monster);

                const portal = document.createElement('img');
                portal.src = 'assets/portal.png';
                portal.className = 'portal-img';
                cell.appendChild(portal);

                grid.appendChild(cell);
            }
            setTimeout(spawnDredge, 500);
        }

        function spawnDredge() {
            document.querySelectorAll('.dretch-active').forEach(img => img.classList.remove('dretch-active'));
            let newIdx;
            do { newIdx = Math.floor(Math.random() * 9); } while(newIdx === currentDredgeIdx);
            currentDredgeIdx = newIdx;
            const cell = document.getElementById(`cell-${currentDredgeIdx}`);
            cell.querySelector('.dretch-img').classList.add('dretch-active');
        }

        function whackDredge(e) {
            e.stopPropagation();
            document.querySelectorAll('.dretch-active').forEach(img => img.classList.remove('dretch-active'));
            setTimeout(spawnDredge, 500);
        }

        function triggerPoison() {
            if(currentDredgeIdx === -1) return;
            const cell = document.getElementById(`cell-${currentDredgeIdx}`);
            const poison = cell.querySelector('.poison-overlay');
            poison.classList.add('poison-active');
            setTimeout(() => poison.classList.remove('poison-active'), 1000);
        }

        // --- GAME 3: BRIDGE ---
        let bridgeActive = false;
        function initBridge() {
            const ui = document.getElementById('bridge-ui');
            const cursor = document.getElementById('spirit-cursor');
            ui.addEventListener('mousemove', (e) => {
                const rect = ui.getBoundingClientRect();
                cursor.style.left = (e.clientX - rect.left) + 'px';
                cursor.style.top = (e.clientY - rect.top) + 'px';
            });
        }
        function enterBridge() {
            bridgeActive = true;
            document.getElementById('spirit-cursor').style.display = 'block';
            document.getElementById('bridge-ui').classList.remove('fail-state');
            document.getElementById('fail-msg').style.display = 'none';
        }
        function fallOffBridge() {
            if (!bridgeActive) return;
            bridgeActive = false;
            document.getElementById('bridge-ui').classList.add('fail-state');
            document.getElementById('fail-msg').style.display = 'block';
            document.getElementById('spirit-cursor').style.display = 'none';
        }

        // --- GAME 5: ROPERS ---
        function updateVials() {
            const maxHP = 50; 
            for(let i=1; i<=4; i++) {
                const val = parseInt(document.getElementById(`dmg-${i}`).value) || 0;
                let pct = (val / maxHP) * 100;
                if(pct > 100) pct = 100;
                document.getElementById(`mask-${i}`).style.height = pct + '%';
            }
        }
        function calculateAggro() {
            const dmg = [
                parseInt(document.getElementById('dmg-1').value) || 0,
                parseInt(document.getElementById('dmg-2').value) || 0,
                parseInt(document.getElementById('dmg-3').value) || 0,
                parseInt(document.getElementById('dmg-4').value) || 0
            ];
            const min = Math.min(...dmg);
            const res = document.getElementById('roper-res');
            if (min === 0 && dmg.every(d => d === 0)) { res.innerHTML = "No damage recorded."; return; }
            let attackers = [];
            dmg.forEach((d, i) => { if (d === min) attackers.push(i + 1); });
            res.innerHTML = `Specimen <span class="attacking-text">${attackers.join(', ')}</span> Enraged (Lowest HP: ${min})`;
        }
    </script>
</body>
</html>
