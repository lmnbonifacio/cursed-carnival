<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Cursed Carnival</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    
    <link rel="preload" as="image" href="assets/bg.webp">
    <link rel="preload" as="image" href="assets/wheel.webp">
    <link rel="preload" as="image" href="assets/pointer.webp">
    <link rel="preload" as="image" href="assets/dretch.webp">
    <link rel="preload" as="image" href="assets/portal.webp">
    <link rel="preload" as="image" href="assets/vial-empty.webp">
    <link rel="preload" as="image" href="assets/vial-complete.webp">

    <style>
        :root {
            --bg-void: #050505;
            --gold-base: #c5a059;
            --gold-highlight: #f0e68c;
            --gold-shadow: #8a6d3b;
            --blood: #8b0000;
            --blood-bright: #ff3333;
            --spirit: #aaddff;
            --poison-gas: #39ff14;
            --glass-panel: rgba(10, 5, 5, 0.90);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Playfair Display', serif;
            background: url('assets/bg.webp') no-repeat center center fixed;
            background-size: cover;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* FIX 1: Move overlay behind everything with z-index -1 */
        body::after {
            content: "";
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, transparent 30%, #000 100%);
            pointer-events: none;
            z-index: -1; 
        }

        .screen {
            position: relative;
            z-index: 10;
            background: var(--glass-panel);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(197, 160, 89, 0.3);
            box-shadow: 0 20px 50px rgba(0,0,0,0.9);
            padding: 40px; 
            border-radius: 8px;
            width: 95%; 
            max-width: 1100px;
            text-align: center; 
            margin: 20px 0;
            animation: fadeIn 0.6s forwards ease-out;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .hidden { display: none !important; }

        h1, h2 { 
            font-family: 'Cinzel', serif; 
            text-transform: uppercase; 
            letter-spacing: 0.15em; 
            margin-bottom: 15px;
            background: linear-gradient(to bottom, var(--gold-highlight), var(--gold-base));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            line-height: 1.2;
        }

        h1 { font-size: 3rem; margin-top: 0; }
        h2 { font-size: 2rem; border-bottom: 1px solid rgba(197, 160, 89, 0.2); padding-bottom: 15px; display: inline-block;}
        p { font-size: 1.1rem; color: #aaa; margin-bottom: 40px; font-style: italic; letter-spacing: 0.05em; }

        /* FIX 3: Add touch-action manipulation to ensure clicks register immediately */
        button {
            background: rgba(0,0,0,0.6);
            color: var(--gold-base);
            border: 1px solid var(--gold-shadow);
            padding: 15px 35px; 
            margin: 10px;
            font-family: 'Cinzel', serif; 
            font-size: 0.9rem; 
            font-weight: 700;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            touch-action: manipulation; 
        }
        button:hover { border-color: var(--gold-highlight); color: var(--gold-highlight); transform: translateY(-2px); box-shadow: 0 0 15px rgba(197, 160, 89, 0.3); }
        button:active { transform: scale(0.95); }

        .back-btn { 
            margin-top: 40px; 
            width: 100%; max-width: 300px;
            border: 1px solid #444; 
            color: #888; 
            background: rgba(0,0,0,0.4); 
        }
        .back-btn:hover { color: #fff; border-color: #fff; background: rgba(255,255,255,0.1); }

        /* --- GAME 1: WHEEL OF HORRORS --- */
        .wheel-stage { 
            position: relative; 
            width: 500px; 
            height: 500px; 
            margin: 0 auto 30px auto; 
            max-width: 100%;
        }
        #wheel-img { width: 100%; height: 100%; transition: transform 5s cubic-bezier(0.2, 0.8, 0.2, 1); filter: drop-shadow(0 0 30px rgba(0,0,0,0.9)); }
        #pointer-img { position: absolute; top: -5%; left: 50%; transform: translateX(-50%); width: 15%; z-index: 10; filter: drop-shadow(0 5px 10px black); }
        .wheel-controls { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
        .wheel-btn { width: 50px; height: 50px; padding: 0; border-radius: 50%; line-height: 50px; }
        
        /* FIX 2: Modal Overlay uses visibility: hidden to prevent invisible blocking */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; 
            visibility: hidden; /* Added */
            transition: opacity 0.3s, visibility 0.3s;
            backdrop-filter: blur(5px);
            padding: 20px;
        }
        .modal-active { opacity: 1; visibility: visible; pointer-events: auto; }
        
        .modal-content {
            background: #111; border: 2px solid var(--gold-base);
            padding: 40px; max-width: 600px; width: 100%; text-align: center;
            box-shadow: 0 0 50px rgba(197, 160, 89, 0.2);
            transform: scale(0.8); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-active .modal-content { transform: scale(1); }
        .modal-title { font-family: 'Cinzel'; font-size: 2.5rem; color: var(--gold-highlight); margin-bottom: 20px; }
        .modal-desc { font-family: 'Playfair Display'; font-size: 1.2rem; line-height: 1.6; color: #ccc; margin-bottom: 30px; }
        .close-modal {
            background: transparent; border: 1px solid #444; color: #888;
            padding: 10px 30px; text-transform: uppercase; letter-spacing: 2px;
        }
        .close-modal:hover { border-color: #fff; color: #fff; }

        /* --- GAME 2: DREDGES --- */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(3, 180px);
            gap: 20px;
            justify-content: center;
            margin: 20px auto;
        }
        .dredge-cell {
            width: 100%; 
            aspect-ratio: 1/1; 
            position: relative; 
            cursor: crosshair;
            overflow: hidden; 
            border-radius: 50%; 
        }
        .portal-img {
            width: 100%; height: 100%; position: absolute; top: 0; left: 0; 
            z-index: 5; pointer-events: none;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.8));
        }
        .dretch-img {
            width: 70%; height: 70%; position: absolute; 
            top: 15%; left: 15%; z-index: 6; 
            border-radius: 50%; object-fit: cover; 
            transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: scale(0);
            filter: drop-shadow(0 0 10px rgba(0,0,0,0.8));
        }
        .dretch-active { transform: scale(1); }
        .poison-overlay {
            position: absolute; top: -10%; left: -10%; width: 120%; height: 120%;
            background: radial-gradient(circle, var(--poison-gas) 20%, transparent 70%);
            opacity: 0; z-index: 10; pointer-events: none;
            mix-blend-mode: hard-light; filter: blur(8px);
        }

        /* --- GAME 3: THE ABYSSAL PATH --- */
        .bridge-container {
            position: relative; 
            width: 100%; 
            max-width: 900px; 
            aspect-ratio: 2/1; 
            margin: 0 auto; 
            background-color: #020202;
            background-image: 
                radial-gradient(circle at 50% 50%, #1a1a2e 0%, transparent 60%),
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
            border: 1px solid #333; 
            box-shadow: inset 0 0 100px #000;
            overflow: hidden; 
            border-radius: 4px;
            touch-action: none; 
        }

        .cursor-none { cursor: none; }
        .cursor-pointer { cursor: pointer; }

        #bridge-hitbox {
            fill: none;
            stroke: transparent;
            stroke-width: 25px; 
            pointer-events: stroke; 
        }

        #bridge-glow {
            fill: none;
            stroke: var(--spirit);
            stroke-width: 40px;
            filter: url(#ectoplasm); 
            opacity: 0.3;
            stroke-linecap: round;
            transition: stroke 0.3s;
        }

        #bridge-stream {
            fill: none;
            stroke: #fff;
            stroke-width: 15px;
            stroke-dasharray: 20, 40; 
            filter: blur(4px);
            opacity: 0.6;
            animation: flowStream 2s linear infinite;
        }

        #bridge-core-vis {
            fill: none;
            stroke: #fff;
            stroke-width: 2px;
            opacity: 0.8;
            filter: drop-shadow(0 0 5px #fff);
        }

        @keyframes flowStream { to { stroke-dashoffset: -60; } }

        #spirit-cursor { 
            width: 30px; height: 30px; 
            background: #fff; 
            border-radius: 50%; 
            position: absolute; 
            pointer-events: none; 
            transform: translate(-50%, -50%); 
            z-index: 20; 
            display: none; 
            mix-blend-mode: screen;
            box-shadow: 0 0 10px #fff, 0 0 20px var(--spirit), 0 0 40px var(--spirit);
            filter: url(#cursor-flicker);
        }

        .fail-state { 
            animation: glitch 0.2s cubic-bezier(.25, .46, .45, .94) both infinite; 
            box-shadow: inset 0 0 150px var(--blood) !important; 
        }
        .fail-state #bridge-glow { stroke: var(--blood); opacity: 0.8; }
        .fail-state #bridge-stream { stroke: var(--blood-bright); }
        
        @keyframes glitch { 
            0% { transform: translate(0); } 
            20% { transform: translate(-2px, 2px); } 
            40% { transform: translate(-2px, -2px); } 
            60% { transform: translate(2px, 2px); } 
            80% { transform: translate(2px, -2px); } 
            100% { transform: translate(0); } 
        }

        .node { fill: var(--gold-base); cursor: pointer; transition: fill 0.3s, r 0.3s; }
        .node:hover { fill: #fff; r: 18px; }
        .start-active { fill: #39ff14; filter: drop-shadow(0 0 10px #39ff14); animation: pulse 1s infinite; }
        .end-zone { fill: var(--spirit); opacity: 0.5; }
        
        @keyframes pulse { 0% { r: 15px; opacity: 1; } 50% { r: 20px; opacity: 0.6; } 100% { r: 15px; opacity: 1; } }

        #bridge-overlay-ui {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 30; text-align: center; pointer-events: none; width: 100%;
        }
        .overlay-msg {
            font-family: 'Cinzel'; font-size: 3rem; 
            text-shadow: 0 0 20px #000;
            display: none;
        }

        /* --- GAME 5: ROPERS (Updated) --- */
        .vial-rack { display: flex; justify-content: center; gap: 20px; margin: 40px 0; perspective: 1000px; flex-wrap: wrap;}
        .vial-unit { display: flex; flex-direction: column; align-items: center; width: 100px; transition: transform 0.3s, opacity 0.3s; }
        .vial-unit:hover { transform: translateZ(20px); }
        .vial-display { width: 100px; height: 200px; position: relative; }
        .vial-bg { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; filter: drop-shadow(0 10px 10px #000); opacity: 0.8; }
        .vial-mask { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; overflow: hidden; z-index: 2; transition: height 0.6s cubic-bezier(0.22, 1, 0.36, 1); filter: drop-shadow(0 0 15px var(--blood)); }
        .vial-fg { width: 100px; height: 200px; position: absolute; bottom: 0; left: 0; }
        .vial-unit input { background: rgba(0,0,0,0.5); border: none; border-bottom: 2px solid var(--gold-shadow); color: var(--gold-highlight); font-family: 'Cinzel'; font-size: 1.5rem; text-align: center; width: 80px; margin-top: 15px; padding: 5px; transition: 0.3s; }
        .vial-unit input:focus { outline: none; border-color: var(--gold-highlight); background: rgba(0,0,0,0.8); }
        
        /* Auto-Highlight Logic Classes */
        .vial-safe { opacity: 0.5; transform: scale(0.95); }
        .vial-danger .vial-mask { filter: drop-shadow(0 0 25px var(--blood-bright)); }
        .vial-danger input { border-color: var(--blood-bright); color: var(--blood-bright); font-weight: bold; }

        /* --- MOBILE OPTIMIZATION --- */
        @media (max-width: 768px) {
            .screen { padding: 20px; width: 100%; margin: 0; border: none; border-radius: 0; height: 100vh; display: flex; flex-direction: column; justify-content: center; overflow-y: scroll;}
            
            /* Typography */
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
            p { font-size: 1rem; margin-bottom: 20px; }
            
            /* Wheel */
            .wheel-stage { width: 85vw; height: 85vw; }
            .wheel-controls { gap: 4px; }
            .wheel-btn { width: 40px; height: 40px; line-height: 40px; }

            /* Dredges - Make columns flexible */
            .grid-container { grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; max-width: 400px; }
            
            /* Bridge - Scaled via SVG aspect ratio */
            .bridge-container { width: 100%; height: auto; }
            .overlay-msg { font-size: 2rem; }
            
            /* Vials */
            .vial-rack { gap: 10px; }
            .vial-unit { width: 80px; }
            .vial-display { width: 80px; height: 160px; }
            .vial-fg { width: 80px; height: 160px; }
            .vial-unit input { width: 60px; font-size: 1.2rem; }
            
            /* Buttons */
            button { width: 100%; margin: 5px 0; padding: 12px; }
            .back-btn { margin-top: 20px; }
        }

    </style>
</head>
<body>

    <div id="hub" class="screen">
        <h1>The Cursed Carnival</h1>
        <p>Select an encounter to begin.</p>
        <div style="display: flex; flex-direction: column; align-items: center; gap: 10px; width: 100%;">
            <button onclick="nav('game1')">I. Wheel of Horrors</button>
            <button onclick="nav('game2')">II. Nine Dredges</button>
            <button onclick="nav('game3')">III. The Spectral Bridge</button>
            <button onclick="nav('game5')">IV. The Ropers</button>
        </div>
    </div>

    <div id="game1" class="screen hidden">
        <h2>Wheel of Horrors</h2>
        <p>Cast a physical die (1d8) and let the wheel decide your fate.</p>
        
        <div class="wheel-stage">
            <img src="assets/pointer.webp" id="pointer-img" alt="Pointer">
            <img src="assets/wheel.webp" id="wheel-img" alt="Wheel">
        </div>

        <div class="wheel-controls">
            <button class="wheel-btn" onclick="spinWheel(1)">1</button>
            <button class="wheel-btn" onclick="spinWheel(2)">2</button>
            <button class="wheel-btn" onclick="spinWheel(3)">3</button>
            <button class="wheel-btn" onclick="spinWheel(4)">4</button>
            <button class="wheel-btn" onclick="spinWheel(5)">5</button>
            <button class="wheel-btn" onclick="spinWheel(6)">6</button>
            <button class="wheel-btn" onclick="spinWheel(7)">7</button>
            <button class="wheel-btn" onclick="spinWheel(8)">8</button>
        </div>

        <button class="back-btn" onclick="nav('hub')">Return to Hub</button>

        <div id="horror-modal" class="modal-overlay">
            <div class="modal-content">
                <div id="m-title" class="modal-title">TITLE</div>
                <div id="m-desc" class="modal-desc">Description goes here.</div>
                <button class="close-modal" onclick="closeModal()">Accept Fate</button>
            </div>
        </div>
    </div>

    <div id="game2" class="screen hidden">
        <h2>Whack-a-Dredge</h2>
        <p>Roll a melee attack. On hit, tap the Dredger.</p>
        <div class="grid-container" id="dredge-grid"></div>
        <button class="back-btn" onclick="nav('hub')">Return to Hub</button>
    </div>

    <div id="game3" class="screen hidden">
        <h2>The Spectral Bridge</h2>
        <p>Drag the soul from <span style="color:#39ff14">Green</span> to <span style="color:var(--spirit)">Blue</span>. Do not touch the void.</p>
        
        <div class="bridge-container cursor-pointer" id="bridge-ui">
            <div id="spirit-cursor"></div>
            
            <div id="bridge-overlay-ui">
                <div id="fail-msg" class="overlay-msg" style="color: var(--blood-bright)">FALLEN</div>
                <div id="win-msg" class="overlay-msg" style="color: var(--gold-highlight)">ASCENDED</div>
                <button id="reset-bridge-btn" onclick="resetBridge()" style="display:none; pointer-events: auto;">Resurrect Soul</button>
            </div>
            
            <svg width="100%" height="100%" viewBox="0 0 900 450" preserveAspectRatio="xMidYMid meet">
                <defs>
                    <filter id="ectoplasm">
                        <feTurbulence type="fractalNoise" baseFrequency="0.02" numOctaves="4" result="noise" />
                        <feDisplacementMap in="SourceGraphic" in2="noise" scale="15" />
                        <feGaussianBlur stdDeviation="3" />
                    </filter>
                    <filter id="cursor-flicker">
                        <feTurbulence type="fractalNoise" baseFrequency="0.1" numOctaves="2" />
                        <feDisplacementMap in="SourceGraphic" scale="3" />
                    </filter>
                </defs>

                <path id="bridge-glow" d="M 50 400 C 80 300, 150 150, 200 150 S 250 350, 300 400 S 400 300, 500 200 S 600 50, 650 50 S 800 200, 850 225" />
                <path id="bridge-stream" d="M 50 400 C 80 300, 150 150, 200 150 S 250 350, 300 400 S 400 300, 500 200 S 600 50, 650 50 S 800 200, 850 225" />
                <path id="bridge-core-vis" d="M 50 400 C 80 300, 150 150, 200 150 S 250 350, 300 400 S 400 300, 500 200 S 600 50, 650 50 S 800 200, 850 225" />
                
                <path id="bridge-hitbox" 
                      d="M 50 400 C 80 300, 150 150, 200 150 S 250 350, 300 400 S 400 300, 500 200 S 600 50, 650 50 S 800 200, 850 225"
                      onmouseenter="confirmOnPath()"
                      onmouseleave="confirmOffPath()" />

                <circle cx="50" cy="400" r="15" class="node start-active" id="start-node" onclick="beginTracing(event)" />
                
                <circle cx="850" cy="225" r="20" class="node end-zone" id="end-node" onmouseenter="checkWin()" />
            </svg>
        </div>

        <button class="back-btn" onclick="nav('hub')">Return to Hub</button>
    </div>

    <div id="game5" class="screen hidden">
        <h2>Specimen Feeding</h2>
        <p>Fill the vials with blood. Input dice rolls. Beware the <span style="color:var(--blood-bright)">Hungriest Specimen</span>.</p>
        
        <div class="vial-rack">
            <div class="vial-unit" id="vial-unit-1">
                <div class="vial-display">
                    <img src="assets/vial-empty.webp" class="vial-bg">
                    <div class="vial-mask" id="mask-1"><img src="assets/vial-complete.webp" class="vial-fg"></div>
                </div>
                <input type="number" id="dmg-1" value="0" oninput="updateVials()">
            </div>
            <div class="vial-unit" id="vial-unit-2">
                <div class="vial-display">
                    <img src="assets/vial-empty.webp" class="vial-bg">
                    <div class="vial-mask" id="mask-2"><img src="assets/vial-complete.webp" class="vial-fg"></div>
                </div>
                <input type="number" id="dmg-2" value="0" oninput="updateVials()">
            </div>
            <div class="vial-unit" id="vial-unit-3">
                <div class="vial-display">
                    <img src="assets/vial-empty.webp" class="vial-bg">
                    <div class="vial-mask" id="mask-3"><img src="assets/vial-complete.webp" class="vial-fg"></div>
                </div>
                <input type="number" id="dmg-3" value="0" oninput="updateVials()">
            </div>
            <div class="vial-unit" id="vial-unit-4">
                <div class="vial-display">
                    <img src="assets/vial-empty.webp" class="vial-bg">
                    <div class="vial-mask" id="mask-4"><img src="assets/vial-complete.webp" class="vial-fg"></div>
                </div>
                <input type="number" id="dmg-4" value="0" oninput="updateVials()">
            </div>
        </div>
        <button class="back-btn" onclick="nav('hub')">Return to Hub</button>
    </div>

    <script>
        // --- NAVIGATION ---
        window.nav = function(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            const active = document.getElementById(id);
            if(active) {
                active.classList.remove('hidden');
                active.style.animation = 'none';
                active.offsetHeight; /* trigger reflow */
                active.style.animation = 'fadeIn 0.6s forwards ease-out';
                if(id === 'game3') resetBridge();
            }
        }

        // --- GAME 1: WHEEL OF HORRORS ---
        const horrorOutcomes = [
            { angle: 202.5, title: "The Skull", desc: "A flurry of poison darts erupts from the walls. <br><br><strong>DEX Save DC 15</strong> or take <strong>4d6 Poison</strong> damage." },
            { angle: 22.5,  title: "The Moon",  desc: "Magical darkness fills the room (1 Min). Darkvision does not penetrate." },
            { angle: 247.5, title: "Diamond",   desc: "A high-pitched ringing shatters your concentration. <br><br><strong>INT Save DC 14</strong> or take <strong>3d8 Psychic</strong> damage." },
            { angle: 292.5, title: "Horseshoe", desc: "Gravity Well: The floor becomes difficult terrain. All movement speeds are halved." },
            { angle: 67.5,  title: "The Star",  desc: "Mirror Image: A duplicate of the boss appears. Attacks against it have a 50% chance to miss." },
            { angle: 157.5, title: "Clover",    desc: "Silence: A sphere of absolute silence centers on the party." },
            { angle: 337.5, title: "The Sun",   desc: "Healing spells cast within the room are maximized." },
            { angle: 112.5, title: "The Heart", desc: "<span style='color:var(--gold-highlight)'>A moment of respite.</span><br>The party regains <strong>2d8 + 4 HP</strong>." }
        ];

        let currentDeg = 0;
        window.spinWheel = function(val) {
            const wheel = document.getElementById('wheel-img');
            const data = horrorOutcomes[val - 1];
            if(!data) return;

            const baseRot = 1080;
            const targetRot = data.angle;
            const jitter = Math.floor(Math.random() * 20) - 10;
            currentDeg = currentDeg + baseRot + (360 - (currentDeg % 360)) + targetRot + jitter;
            
            wheel.style.transform = `rotate(-${currentDeg}deg)`; 
            
            setTimeout(() => {
                showModal(val);
            }, 5000); 
        }

        function showModal(val) {
            const data = horrorOutcomes[val - 1];
            if(!data) return;
            document.getElementById('m-title').innerHTML = data.title;
            document.getElementById('m-desc').innerHTML = data.desc;
            document.getElementById('horror-modal').classList.add('modal-active');
        }

        window.closeModal = function() {
            document.getElementById('horror-modal').classList.remove('modal-active');
        }

        // --- GAME 2: DREDGES ---
        let currentDredgeIdx = -1;
        function initDredges() {
            const grid = document.getElementById('dredge-grid');
            if(!grid) return;
            grid.innerHTML = '';
            for(let i=0; i<9; i++) {
                const cell = document.createElement('div');
                cell.className = 'dredge-cell';
                cell.id = `cell-${i}`;
                
                const poison = document.createElement('div');
                poison.className = 'poison-overlay';
                cell.appendChild(poison);

                const monster = document.createElement('img');
                monster.src = 'assets/dretch.webp';
                monster.className = 'dretch-img';
                
                // Add touchstart for better mobile responsiveness
                monster.addEventListener('touchstart', (e) => {
                    e.preventDefault(); // Prevent double firing
                    whackDredge(e);
                });
                monster.onclick = (e) => whackDredge(e);
                
                cell.appendChild(monster);

                const portal = document.createElement('img');
                portal.src = 'assets/portal.webp';
                portal.className = 'portal-img';
                cell.appendChild(portal);

                grid.appendChild(cell);
            }
            setTimeout(spawnDredge, 500);
        }

        function spawnDredge() {
            document.querySelectorAll('.dretch-active').forEach(img => img.classList.remove('dretch-active'));
            let newIdx;
            do { newIdx = Math.floor(Math.random() * 9); } while(newIdx === currentDredgeIdx);
            currentDredgeIdx = newIdx;
            const cell = document.getElementById(`cell-${currentDredgeIdx}`);
            if(cell) cell.querySelector('.dretch-img').classList.add('dretch-active');
        }

        function whackDredge(e) {
            e.stopPropagation();
            document.querySelectorAll('.dretch-active').forEach(img => img.classList.remove('dretch-active'));
            setTimeout(spawnDredge, 500);
        }

        // --- GAME 3: BRIDGE (UPDATED FOR TOUCH) ---
        let tracingActive = false;
        let isOnPath = false;
        let hasWon = false;

        const bridgeUI = document.getElementById('bridge-ui');
        const cursor = document.getElementById('spirit-cursor');

        // MOUSE EVENTS
        if(bridgeUI) {
            bridgeUI.addEventListener('mousemove', (e) => {
                if (!tracingActive) return;
                moveCursor(e.clientX, e.clientY);
            });
            
            // TOUCH EVENTS
            bridgeUI.addEventListener('touchmove', (e) => {
                if(!tracingActive) return;
                e.preventDefault(); // Prevent page scrolling while playing
                const touch = e.touches[0];
                moveCursor(touch.clientX, touch.clientY);
                
                // Manual Collision Check for Touch
                // Because onmouseenter doesn't work with touch dragging
                checkTouchCollision(touch.clientX, touch.clientY);
            }, { passive: false });
        }

        function moveCursor(x, y) {
            const rect = bridgeUI.getBoundingClientRect();
            // Constrain cursor to box
            const relX = x - rect.left;
            const relY = y - rect.top;
            
            cursor.style.left = relX + 'px';
            cursor.style.top = relY + 'px';
        }

        function checkTouchCollision(x, y) {
            if(hasWon) return;
            
            // Get element under finger
            const el = document.elementFromPoint(x, y);
            
            // Check if we hit the end zone
            if(el && el.id === 'end-node') {
                checkWin();
                return;
            }
            
            // Check if we are ON the path
            // The SVG structure puts the hitbox on top. 
            if(el && el.id === 'bridge-hitbox') {
                isOnPath = true;
            } else if (el && el.id === 'spirit-cursor') {
                 // Ignore self
            } else {
                // If we are touching the background, we fail
                if(tracingActive) confirmOffPath();
            }
        }

        window.resetBridge = function() {
            tracingActive = false;
            isOnPath = false;
            hasWon = false;
            bridgeUI.classList.remove('fail-state');
            bridgeUI.classList.remove('cursor-none');
            bridgeUI.classList.add('cursor-pointer');
            cursor.style.display = 'none';
            document.getElementById('fail-msg').style.display = 'none';
            document.getElementById('win-msg').style.display = 'none';
            document.getElementById('reset-bridge-btn').style.display = 'none';
            document.getElementById('start-node').classList.add('start-active');
        }

        window.beginTracing = function(e) {
            e.preventDefault();
            if (hasWon) return;
            tracingActive = true;
            isOnPath = true; 
            bridgeUI.classList.add('cursor-none');
            bridgeUI.classList.remove('cursor-pointer');
            
            cursor.style.display = 'block';
            
            // Handle both touch/mouse coordinates
            let clientX = e.clientX;
            let clientY = e.clientY;
            if(e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            }
            
            moveCursor(clientX, clientY);
            document.getElementById('start-node').classList.remove('start-active');
        }
        
        // Add touchstart listener to the start node specifically
        document.getElementById('start-node').addEventListener('touchstart', beginTracing);

        window.confirmOnPath = function() {
            if (!tracingActive) return;
            isOnPath = true;
        }

        window.confirmOffPath = function() {
            if (!tracingActive || hasWon) return;
            isOnPath = false;
            triggerFail();
        }

        function triggerFail() {
            tracingActive = false;
            bridgeUI.classList.add('fail-state');
            document.getElementById('fail-msg').style.display = 'block';
            document.getElementById('reset-bridge-btn').style.display = 'inline-block';
            bridgeUI.classList.remove('cursor-none');
            bridgeUI.classList.add('cursor-pointer');
        }

        window.checkWin = function() {
            if (tracingActive && isOnPath) {
                hasWon = true;
                tracingActive = false;
                document.getElementById('win-msg').style.display = 'block';
                bridgeUI.classList.remove('cursor-none');
                bridgeUI.classList.add('cursor-pointer');
            }
        }

        // --- GAME 5: ROPERS ---
        window.updateVials = function() {
            const maxHP = 50; 
            const inputs = [
                { id: 1, val: parseInt(document.getElementById(`dmg-1`).value) || 0 },
                { id: 2, val: parseInt(document.getElementById(`dmg-2`).value) || 0 },
                { id: 3, val: parseInt(document.getElementById(`dmg-3`).value) || 0 },
                { id: 4, val: parseInt(document.getElementById(`dmg-4`).value) || 0 }
            ];

            inputs.forEach(item => {
                let pct = (item.val / maxHP) * 100;
                if(pct > 100) pct = 100;
                document.getElementById(`mask-${item.id}`).style.height = pct + '%';
            });

            const allZero = inputs.every(i => i.val === 0);
            if (allZero) {
                document.querySelectorAll('.vial-unit').forEach(u => {
                    u.classList.remove('vial-danger', 'vial-safe');
                });
                return;
            }

            const minVal = Math.min(...inputs.map(i => i.val));
            inputs.forEach(item => {
                const unit = document.getElementById(`vial-unit-${item.id}`);
                if (item.val === minVal) {
                    unit.classList.add('vial-danger');
                    unit.classList.remove('vial-safe');
                } else {
                    unit.classList.add('vial-safe');
                    unit.classList.remove('vial-danger');
                }
            });
        }

        // --- INIT ---
        initDredges();
    </script>
</body>
</html>
